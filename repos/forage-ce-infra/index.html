
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Auto-aggregated readme contents">
      
      
        <meta name="author" content="msashish">
      
      
        <link rel="canonical" href="https://msashish.github.io/auto-doco/repos/forage-ce-infra/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>forage-ce-infra - Ash Engineering Bytes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#forage-ce-infra" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Ash Engineering Bytes" class="md-header__button md-logo" aria-label="Ash Engineering Bytes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ash Engineering Bytes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              forage-ce-infra
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  Repositories

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../subnet/" class="md-tabs__link">
        
  
  
    
  
  Subnet

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../helpme/" class="md-tabs__link">
        
  
  
    
  
  Help

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Ash Engineering Bytes" class="md-nav__button md-logo" aria-label="Ash Engineering Bytes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ash Engineering Bytes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repositories
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../subnet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subnet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helpme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Help
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-setting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Basic setting
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-infra-on-your-gcp-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        Building infra on your GCP project
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-secrets-for-use-by-application" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create secrets for use by Application
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-infra-spin-up-using-below" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validate infra spin-up using below
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-manually-configure-kubectl" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to manually configure kubectl:
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#if-you-want-to-change-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        If you want to change project
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-know-available-gke-node-version" class="md-nav__link">
    <span class="md-ellipsis">
      
        To know available gke node version
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-destroy-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      
        To Destroy infrastructure
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="forage-ce-infra">forage-ce-infra<a class="headerlink" href="#forage-ce-infra" title="Permanent link">&para;</a></h1>
<p><a href="https://github.com/msashish/forage-ce-infra">View on GitHub</a></p>
<hr />
<h2 id="basic-setting">Basic setting<a class="headerlink" href="#basic-setting" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>    1) Install Cloud SDK, Terraform, kubectl

            terraform version (Terraform v0.14.2)
            kubectl version --client (16+)
            Google Cloud SDK 320.0.0

    2) Enable Cloud SQL Admin API for project

    3) Create service account terraform-sa in GCP project for terraform purpose

    4) Grant service account, owner access on GCP project

    5) Create service account key credential and set GOOGLE_APPLICATION_CREDENTIALS

            export GOOGLE_APPLICATION_CREDENTIALS=&quot;path to key file&quot;

    6) Create service account cloudsql-sa in GCP project for interactions with Cloud SQL

    7) Grant access as Cloud SQL Client or Cloud SQL Admin or Cloud SQL Edit based on need

            Cloud SQL Client IAM roles

    8) Create Cloud SQL service account key

    9) Initialise gcloud connectivity to the project

            gcloud init
</code></pre></div>
<h2 id="building-infra-on-your-gcp-project">Building infra on your GCP project<a class="headerlink" href="#building-infra-on-your-gcp-project" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>    1) Configurations for firewall, subnetwork and vpc:
            backend/firewall/main.tf
            backend/subnet/main.tf
            backend/vpc/main.tf

    2) Configurations for cloudsql
            cloudsql/main.tf

    3) Configurations for GKE cluster
            gke/main.tf

    4) Main terraform configuration
            main.tf

    5) Ensure project id an region are set in variables.tf

    6) Apply configuration to spin-up infra (several minutes)

            terraform init 
            terraform workspace new dev
            (if on some other workspace) terraform workspace select dev  
            terraform plan
            terraform apply
</code></pre></div>
<h2 id="create-secrets-for-use-by-application">Create secrets for use by Application<a class="headerlink" href="#create-secrets-for-use-by-application" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>    1) Create Database secret on GKE

        kubectl create secret generic postgres-secret \
            --from-literal=username=postgres \
            --from-literal=password=YourPassword \
            --from-literal=database=postgres

    2) Create cloussql service account secret on GKE

        kubectl create secret generic cloudsql-sa \
        --from-file=service_account.json=&lt;path to key file&gt;
</code></pre></div>
<h2 id="validate-infra-spin-up-using-below">Validate infra spin-up using below<a class="headerlink" href="#validate-infra-spin-up-using-below" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>    1) Basic check

            terraform show
            terraform state list (List and show Terraform state file)
            terraform state show

    2) Validate GKE cluster created

            gcloud container clusters get-credentials gke-dev-cluster --region=us-central1

    3) Validate sql instance created (state as RUNNABLE)

            gcloud sql instances describe &lt;instance name&gt; --project &lt;project id&gt;
              gcloud sql instances describe sql-dev-47bf6f57 --project qwiklabs-gcp-01-c81a26698645

    3) Test connection to sql instance

            gcloud sql connect &lt;instance name&gt; --user=postgres --quiet

    4) Verify k8 objects

            kubectl get namespace
            kubectl get pod
            kubectl logs [POD] -c gke-test
            kubectl exec [POD] -- [COMMAND]
</code></pre></div>
<h2 id="how-to-manually-configure-kubectl">How to manually configure kubectl:<a class="headerlink" href="#how-to-manually-configure-kubectl" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>     When we use gcloud commands, it adds cluster details to kubectl config  
            ex: at $HOME/.kube/config

     If not, run below to add entry to kubectl config

            gcloud container clusters get-credentials &lt;cluster name&gt; --region=&lt;cluster region&gt;
            gcloud container clusters get-credentials gke-dev-cluster --region=us-central1
</code></pre></div>
<h2 id="if-you-want-to-change-project">If you want to change project<a class="headerlink" href="#if-you-want-to-change-project" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>    0) Ensure proxy settings are clean

        &lt;ensure proxy is unset and off n/w&gt;
            gcloud config unset proxy/port
            gcloud config unset proxy/type
            gcloud config unset proxy/address

    1) Reset GOOGLE_APPLICATION_CREDENTIALS with new key

            export GOOGLE_APPLICATION_CREDENTIALS=&quot;path to key file&quot;

    2) Change existing gcloud config OR create a new one using new project id

            gcloud init

    3) Terraform cleanup

            Delete .terraform directory, lock and state files
            Change project-id, region in variables.tf
            Re-build infra
</code></pre></div>
<h2 id="to-know-available-gke-node-version">To know available gke node version<a class="headerlink" href="#to-know-available-gke-node-version" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>            gcloud container get-server-config
</code></pre></div>
<h2 id="to-destroy-infrastructure">To Destroy infrastructure<a class="headerlink" href="#to-destroy-infrastructure" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>            terraform destroy -auto-approve
            terraform destroy - target=module.cloudsql  (for module)
</code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.top", "search.highlight", "search.share", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>